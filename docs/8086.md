# 8086

## 主引导扇区

主引导扇区是硬盘的第一个扇区，大小为 512B，主要用于读取内核加载器，然后跳转到那里继续执行。

- 代码：446B。
- 硬盘分区表：64B = 4 * 16B。
- 魔数：2B。`0x55` 和 `0xaa`。

## int 0x10

中断号 0x10 为 BIOS 视频服务中断，通过 AH 寄存器指定功能号，其他寄存器提供参数。

| AH   | 功能         | 参数说明                                   |
| ---- | ------------ | ------------------------------------------ |
| 0x00 | 设置显示模式 | AL = 模式号，例如 03h = 80x25 彩色文本模式 |
| 0x01 | 设置光标位置 | CH = 行, CL = 列                           |
| 0x0e | 打印字符     | AL = ASCII 字符, BH = 页号, BL = 属性      |
| 0x13 | 绘制像素     | CX = 列数, DX = 行数, AL = 颜色            |

例如：

- 把屏幕设置成 80 列 × 25 行彩色文本模式：

    ```nasm
    mov ah, 0x00
    mov al, 0x03
    int 0x10
    ```

- 打印字符：

    ```nasm
    mov ah, 0x0e
    mov al, 'H'
    int 0x10
    ```

    会在当前光标位置显示一个 H，并并自动移动光标到下一个位置。

## 硬盘读写

- 寻址方式：

  - CHS（Cylinder-Head-Sector，柱面-磁头-扇区）：
    - 通过柱面号、磁头号和扇区号来定位一个扇区。

  - LBA（Logical Block Addressing，逻辑块寻址）：
    - 整个硬盘被看成是一个线性扇区数组，每个扇区有一个编号（从 0 开始）。

- 硬盘端口号：

    | Primary 通道 | Secondary 通道 | in 操作      | out 操作     |
    | ------------ | -------------- | ------------ | ------------ |
    | 0x1F0        | 0x170          | Data         | Data         |
    | 0x1F1        | 0x171          | Error        | Features     |
    | 0x1F2        | 0x172          | Sector count | Sector count |
    | 0x1F3        | 0x173          | LBA low      | LBA low      |
    | 0x1F4        | 0x174          | LBA mid      | LBA mid      |
    | 0x1F5        | 0x175          | LBA high     | LBA high     |
    | 0x1F6        | 0x176          | Device       | Device       |
    | 0x1F7        | 0x177          | Status       | Command      |

  - 0x1F0：数据寄存器，16 位，用于读写数据。
  - 0x1F1：检测前一个指令的错误。
  - 0x1F2：读写的扇区数量。
  - 0x1F3：起始扇区的 0 ~ 7 位。
  - 0x1F4：起始扇区的 8 ~ 15 位。
  - 0x1F5：起始扇区的 16 ~ 23 位。
  - 0x1F6:
    - 第 0 ~ 3 位：起始扇区的 24 ~ 27 位。
    - 第 4 位：0 主盘, 1 从片。
    - 第 6 位：0 CHS, 1 LBA。
    - 第 5 ~ 7 位：固定为 1。
  - 0x1F7：状态或命令寄存器，8 位。
    - in：
      - 第 0 位：ERR - 错误。
      - 第 3 位：DRQ - 数据准备完毕。
      - 第 7 位：BSY - 硬盘繁忙。
    - out：
      - 0xEC：识别硬盘。
      - 0x20：读硬盘。
      - 0x30：写硬盘。

## 实模式下的内存布局

| 起始地址  | 结束地址  | 大小     | 用途               |
| --------- | --------- | -------- | ------------------ |
| `0x000`   | `0x3FF`   | 1KB      | 中断向量表         |
| `0x400`   | `0x4FF`   | 256B     | BIOS 数据区        |
| `0x500`   | `0x7BFF`  | 29.75KB  | 可用区域           |
| `0x7C00`  | `0x7DFF`  | 512B     | MBR 加载区域       |
| `0x7E00`  | `0x9FBFF` | 607.6KB  | 可用区域           |
| `0x9FC00` | `0x9FFFF` | 1KB      | 扩展 BIOS 数据区   |
| `0xA0000` | `0xAFFFF` | 64KB     | 用于彩色显示适配器 |
| `0xB0000` | `0xB7FFF` | 32KB     | 用于黑白显示适配器 |
| `0xB8000` | `0xBFFFF` | 32KB     | 用于文本显示适配器 |
| `0xC0000` | `0xC7FFF` | 32KB     | 显示适配器 BIOS    |
| `0xC8000` | `0xEFFFF` | 160KB    | 映射内存           |
| `0xF0000` | `0xFFFEF` | 64KB-16B | 系统 BIOS          |
| `0xFFFF0` | `0xFFFFF` | 16B      | 系统 BIOS 入口地址 |

## 内存检测

中断号 0x15 为 BIOS 系统服务类中断，AX = 0xE820 可用于检测物理内存布局。具体地：

- ARDS（Address Range Descriptor Structure，地址范围描述结构体）：

  | 字节偏移量 | 属性名称     | 描述                             |
  | ---------- | ------------ | -------------------------------- |
  | 0          | BaseAddrLow  | 基地址的低 32 位                 |
  | 4          | BaseAddrHigh | 基地址的高 32 位                 |
  | 8          | LengthLow    | 内存长度的低 32 位，以字节为单位 |
  | 12         | LengthHigh   | 内存长度的高 32 位，以字节为单位 |
  | 16         | Type         | 本段内存的类型                   |

  - Type 字段：

    | Type 值 | 名称                 | 描述                                                                                   |
    | ------- | -------------------- | -------------------------------------------------------------------------------------- |
    | 1       | AddressRangeMemory   | 这段内存可以被操作系统使用。                                                             |
    | 2       | AddressRangeReserved | 内存使用中或者被系统保留，操作系统不可以用此内存。                                       |
    | 3       |                      | 存储 ACPI 表，可以被操作系统回。收。                                                       |
    | 4       |                      | 操作系统不可使用这段内存。                                                             |
    | 5       |                      | 已经损坏的内存区域，不可使用。                                                         |
    | 其他    | 未定义               | 未定义。将来会用到，目前保留，但是需要操作系统一样将其视为 ARR（AddressRangeReserved） |

- 中断调用传入：

  | 寄存器/状态位   | 参数说明                                                                                                                                                                                               |
  | --------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
  | EAX   | 子功能号。用于指定中断子功能号，此处应设为 `0xE820`。                                                                                                                                                                    |
  | EBX   | 后续值。内存信息需按类型分多次返回，每次调用仅返回一个 ARDS。BIOS 会在返回时更新 EBX，用于指示下一个待返回的 ARDS 位置。首次调用时必须将 EBX 置为 0，之后每次调用都需传入上一次返回的 EBX 值。该值的具体内容由 BIOS 实现决定，调用者无需关心。 |
  | ES:DI | ARDS 缓冲区地址。BIOS 将系统内存映射信息以 ARDS 结构写入此地址处的缓冲区。                                                                                                                                                      |
  | ECX   | ARDS 结构的字节长度。用于指示 BIOS 应写入的数据结构大小。通常为 20 字节（当前版本标准长度），未来可能扩展。                                                                                                                                      |
  | EDX   | 固定签名 `0x534D4150`（字符串 `"SMAP"` 的 ASCII 码）。用于标识调用者请求的内存映射信息类型，BIOS 返回数据后将使用此签名进行校验。                                                                                                                 |

- 中断调用传出：

  | 寄存器/状态位   | 参数说明                                                                                          |
  | --------- | --------------------------------------------------------------------------------------------- |
  | **CF 位**  | 调用结果标志。CF=0 表示调用成功；CF=1 表示调用失败。                                                               |
  | **EAX**   | 返回 `"SMAP"` 签名（`0x534D4150`），用于确认返回数据有效。                                                      |
  | **ES:DI** | 与输入相同，为 ARDS 缓冲区地址。返回时该缓冲区已由 BIOS 填充内存映射信息。                                                   |
  | **ECX**   | 实际写入的字节数。BIOS 至少会写入 20 字节。                                                                    |
  | **EBX**   | 后续值。BIOS 更新此值以指示下一次调用应从哪个 ARDS 继续获取。若 CF=0 且返回的 EBX=0，则表示已到达最后一个 ARDS 结构。 |

## 保护模式

- 全局描述符：

  ![alt text](./image.png)

  ```c
  typedef struct descriptor /* 共 8 个字节 */
  {
      unsigned short limit_low;      // 段界限 0 ~ 15 位
      unsigned int base_low : 24;    // 基地址 0 ~ 23 位 16M
      unsigned char type : 4;        // 段类型
      unsigned char segment : 1;     // 1 表示代码段或数据段，0 表示系统段
      unsigned char DPL : 2;         // Descriptor Privilege Level 描述符特权等级 0 ~ 3
      unsigned char present : 1;     // 存在位，1 在内存中，0 在磁盘上
      unsigned char limit_high : 4;  // 段界限 16 ~ 19;
      unsigned char available : 1;   // 该安排的都安排了，送给操作系统吧
      unsigned char long_mode : 1;   // 64 位扩展标志
      unsigned char big : 1;         // 32 位 还是 16 位;
      unsigned char granularity : 1; // 粒度 4KB 或 1B
      unsigned char base_high;       // 基地址 24 ~ 31 位
  } __attribute__((packed)) descriptor;
  ```
