# 学习笔记

## 主引导扇区

主引导扇区是硬盘的第一个扇区，大小为 512B，主要用于读取并执行内核加载器：

- 代码：446B。
- 硬盘分区表：64B = 4 * 16B。
- 魔数：2B。`0x55` 和 `0xaa`。

## int 0x10

中断号 0x10 为 BIOS 视频服务中断，通过 AH 寄存器指定功能号，其他寄存器提供参数。

| AH  | 功能         | 参数说明                                   |
| --- | ------------ | ------------------------------------------ |
| 0x00 | 设置显示模式 | AL = 模式号，例如 03h = 80x25 彩色文本模式 |
| 0x01 | 设置光标位置 | CH = 行, CL = 列                           |
| 0x0e | 打印字符     | AL = ASCII 字符, BH = 页号, BL = 属性      |
| 0x13 | 绘制像素     | CX = 列数, DX = 行数, AL = 颜色            |

例如：

- 把屏幕设置成 80 列 × 25 行彩色文本模式：

    ```nasm
    mov ah, 0x00
    mov al, 0x03
    int 0x10
    ```

- 打印字符：

    ```nasm
    mov ah, 0x0e
    mov al, 'H'
    int 0x10
    ```

    会在当前光标位置显示一个 H，并并自动移动光标到下一个位置。

## 硬盘读写

- 读写模式：

  - CHS 模式：Cylinder + Head + Sector。最大支持 1024 个柱面，每个柱面 16 个磁头，每个磁头 63 个扇区。所以，最大可寻址容量为：

    $$
    1024×16×63×512B≈528 MB
    $$

  - LBA 模式：每个扇区都有一个唯一的编号（从 0 开始）。LBA28 最大可寻址容量为：

    $$
    2^{28}×512B=128 GB
    $$

- I/O 端口

    | Primary 通道            | Secondary 通道 | in 操作      | out 操作     |
    | ----------------------- | -------------- | ------------ | ------------ |
    | 0x1F0                   | 0x170          | Data         | Data         |
    | 0x1F1                   | 0x171          | Error        | Features     |
    | 0x1F2                   | 0x172          | Sector count | Sector count |
    | 0x1F3                   | 0x173          | LBA low      | LBA low      |
    | 0x1F4                   | 0x174          | LBA mid      | LBA mid      |
    | 0x1F5                   | 0x175          | LBA high     | LBA high     |
    | 0x1F6                   | 0x176          | Device       | Device       |
    | 0x1F7                   | 0x177          | Status       | Command      |

  - 0x1F0：数据寄存器，16 位，用于读写数据。
  - 0x1F1：检测前一个指令的错误。
  - 0x1F2：读写的扇区数量。
  - 0x1F3：起始扇区的 0 ~ 7 位。
  - 0x1F4：起始扇区的 8 ~ 15 位。
  - 0x1F5：起始扇区的 16 ~ 23 位。
  - 0x1F6:
    - 第 0 ~ 3 位：起始扇区的 24 ~ 27 位。
    - 第 4 位：0 主盘, 1 从片。
    - 第 6 位：0 CHS, 1 LBA。
    - 第 5 ~ 7 位：固定为 1。
  - 0x1F7：状态或命令寄存器，8 位。
    - in：
      - 第 0 位：ERR - 错误。
      - 第 3 位：DRQ - 数据准备完毕。
      - 第 7 位：BSY - 硬盘繁忙。
    - out：
      - 0xEC：识别硬盘。
      - 0x20：读硬盘。
      - 0x30：写硬盘。
